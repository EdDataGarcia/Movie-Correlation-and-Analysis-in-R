---
title: "Movie Correlation and Analysis in R"
author: "Ed Garcia"
date: "8/29/2021"
output:
  pdf_document:
    toc: true
    toc_depth: 2
---

```{r}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# Project Questions

* In the past four decades, were high budgets, huge star power, or a franchise tag necessary to make a top grossing or top profitable movie?

* What other variables helped create a financially successful movie?

* What can be learned from movie trends of the last four decades?

# Source Data and Inspiration

* This project used the ["Movie Industry, Four Decades of Movies"](https://www.kaggle.com/danielgrijalvas/movies) data set posted on Kaggle by Daniel Grijalva.

* This project was inspired and informed from Alex Freberg's ["Correlation in Python"](https://www.youtube.com/watch?v=iPYVYBtUTyE&ab_channel=AlexTheAnalyst) tutorial project on YouTube.

* My mind works better in R than in Python, so I practiced translating Python code and analysis steps into R. 

* I also translated my analysis into a user-friendly dashboard for public consumption. I was inspired and informed from the structure of Abhishek Agarrwal's ["Tableau IMDB Movies Ratings Data Analysis and Dashboard Project Tutorial for Practice"](https://www.youtube.com/watch?v=xwO9xK4xUKM&ab_channel=AviSingh-PowerBIPro) project on YouTube.

* My published dashboard is available [here](https://public.tableau.com/app/profile/ed.garcia/viz/Movies1980-2020/Movies1980-2020#1).

# PROJECT SETUP

Import libraries:
```{r}
library(tidyverse) # I'm a big fan of dplyr
library(kableExtra) # for pretty tables
library(reshape2) # for melting the correlation matrix
library(superml) # for encoding categorical data in correlation matrix
```

Import data: movies <- read.csv("filepath/filename.csv")
```{r, include=FALSE}
movies <- read.csv("C:/Users/garci/OneDrive/Desktop/Data Analysis Education/Alex the Analyst Projects/Movies/movies.csv")
```

Glimpse the data:
```{r}
glimpse(movies) # Released column should be formatted as a date
```

Summarize the data:
```{r}
summary(movies) # nulls will need to be addressed
```

# DATA CLEANING

**Discrepancy between the Year and Released columns: they do not always align.** 

Inspect the discrepancy:
```{r}
kable(head(movies[, c(1,4,5)], 10)) %>% 
  kableExtra::kable_styling(latex_options = c("hold_position"), full_width = FALSE)
```

After researching the source data on IMDB, I determined that: 

* the Year column refers to the year of the movie's first premiere showing

* the Released column refers to the date of the movie's first full-scale release 

* The country in which the movie was released is parenthesized in the Release column 

**Clean the Year and Released columns to clarify the discrepancy.**

Rename Year column to Premiere Year:
```{r}
movies <- movies %>% 
  rename(premiere = year) 
```

Split Released column into Full Release Date and Full Release Location columns:
```{r}
# this creates the separated date and location
split <- unlist(strsplit(movies$released, split="[()]"))
# this creates the new column names
cols <- c("full_release_date", "full_release_location")
# the following steps set up the re-insertion into the data frame
nC <- length(cols)
ind <- seq(from=1, by=nC, length=nrow(movies))
for(i in 1:nC) {movies[, cols[i]] <- split[ind + i - 1]}
```

Change Full Release Date column to date format:
```{r}
movies$full_release_date <- as.Date(movies$full_release_date, "%B %d, %Y")
```

Remove the now-irrelevant Released column:
```{r}
movies <- movies %>% 
  select(-c(released))
```

Drop any duplicate rows:
```{r}
nrow(movies) # 7668 total rows
nrow(distinct(movies)) # 7668 total distinct rows
# there are no duplicate rows
```

**Determine profit for each movie.**

Make a Profit column:
```{r}
movies$profit <- movies$gross - movies$budget
```

Convert the gross, budget, and profit to millions to increase readability:
```{r}
movies$gross <- movies$gross / 1000000
movies$budget <- movies$budget / 1000000
movies$profit <- movies$profit / 1000000
movies <- movies %>% 
rename(grossM = gross, budgetM = budget, profitM = profit)
```

Make a Profit Percentage column:
```{r}
movies$profit_percent <- (movies$profitM / movies$budgetM) * 100
```

**Clean the Rating column.**

Find out what ratings are used in this data set:  
```{r}
unique(movies$rating)
```

Unite Unrated and Not Rated ratings:
```{r}
movies["rating"][movies["rating"] == "Not Rated"] <- "Unrated"
```

Print the movies that are rated Approved:
```{r}
subset(movies, rating == "Approved")
# The only movie with an Approved rating is "Tarzan the Ape Man". 
  # Upon further research on IMDB, the movie poster states that the movie is rated R.
```

Unite Approved and R ratings:
```{r}
movies["rating"][movies["rating"] == "Approved"] <- "R"
```

Unite other ratings as Other:
```{r}
movies["rating"][movies["rating"] == ""] <- "Other"
movies["rating"][movies["rating"] == "X"] <- "Other"
movies["rating"][movies["rating"] == "NC-17"] <- "Other"
movies["rating"][movies["rating"] == "TV-PG"] <- "Other"
movies["rating"][movies["rating"] == "TV-14"] <- "Other"
movies["rating"][movies["rating"] == "TV-MA"] <- "Other"
```

**Clean the Genre column, create a Decades column, and a note about NULLs.**

Find out what genres are used in this data set:
```{r}
unique(movies$genre) 
```

Unite Musical and Music ratings:
```{r}
movies["genre"][movies["genre"] == "Music"] <- "Musical" # Only one entry as Music
movies["genre"][movies["genre"] == "History"] <- "Biography" # Only one entry as History
movies["genre"][movies["genre"] == "Sport"] <- "Drama" # Only one entry as Sport
```

Create a decades column:
```{r}
movies$decade <- as.numeric(format(movies$full_release_date, format="%Y")) 
movies$decade <- round(movies$decade, -1) 
```

I am leaving null values in the data set, and will remove them on a case-by-case scenario.

# DATA EXPLORATION

**Which variables (stars, directors, writers, companies) were involved in the highest grossing movies?**
```{r}
movies %>% 
  select(c(name, premiere, star, director, writer, company, grossM)) %>% 
  arrange(desc(grossM)) %>% 
  top_n(20) %>% 
  knitr::kable(caption = "Top 20 Grossing Movies: Personnel", digits = 0) %>% 
  kableExtra::kable_styling(latex_options = c("hold_position")) %>% 
  column_spec(c(1,3:6), width = "3cm")
```
Except for Avatar and Titanic, all the Top 20 grossing movies premiered in the last decade. 

* This makes sense, since movies' gross will continue to rise due to inflation's impact on the cost of movie ticket sales.

There were many stars that appear multiple times.

* This can be explained by the fact that many of these movies are franchises (Avengers, Star Wars, Furious) which utilize multi-movie contracts with their stars

Other highlights: 

* James Cameron appears twice in the top 3 of director and writer

* No female directors. Jennifer Lee was the only female writer, appearing twice for the Frozen movies

* Only 7 companies: 20th Century Fox, Marvel, Lucasfilm, Disney, Universal, Warner Bros, Mandeville

\newpage

**Which variables (stars, directors, writers, companies) were involved in the most profitable ($) movies?**
```{r}
movies %>% 
  select(c(name, premiere, star, director, writer, company, profitM)) %>% 
  arrange(desc(profitM)) %>% 
  top_n(20) %>% 
  knitr::kable(caption = "Top 20 Profitable Movies: Personnel", digits = 0) %>% 
  kableExtra::kable_styling(latex_options = c("hold_position")) %>% 
  column_spec(c(1,3:6), width = "3cm")
```
Not much difference between the variables in the Top 20 profitable ($) list and the Top 20 grossing list (this was expected).

**Which variables (stars, directors, writers, companies) were involved in the movies with the highest profit percentage?**
```{r}
movies %>% 
  select(c(name, premiere, star, director, writer, company, profit_percent)) %>% 
  arrange(desc(profit_percent)) %>% 
  top_n(20) %>% 
  knitr::kable(caption = "Top 20 Profit Percentage Movies: Personnel", digits = 0) %>% 
  kableExtra::kable_styling(latex_options = c("hold_position")) %>% 
  column_spec(c(1,3:6), width = "3cm")
```

**The Top 20 profitable (%) list contains more variety compared to the Top 20 grossing and Top 20 profitable ($) lists.** 

* There was at least 1 movie in each decade (80s, 90s, 00s, 10s).

* No sequels (i.e., these movies were not franchises when they were created).

* There were no stars, directors, writers, or companies that appear more than once.

* In general, these movies succeeded in profitability despite their low budget.

Look at the financial numbers of these 3 lists:
```{r}
movies %>% 
  select(c(name, budgetM, profitM, profit_percent, grossM)) %>% 
  arrange(desc(grossM)) %>% 
  top_n(20) %>% 
  knitr::kable(caption = "Top 20 Grossing Movies: Finances", digits = 0) %>% 
  kableExtra::kable_styling(latex_options = c("hold_position"))
```
```{r}
movies %>% 
  select(c(name, budgetM, grossM, profit_percent, profitM)) %>% 
  arrange(desc(profitM)) %>% 
  top_n(20) %>% 
  knitr::kable(caption = "Top 20 Profitable Movies: Finances", digits = 0) %>% 
  kableExtra::kable_styling(latex_options = c("hold_position"))
```
```{r}
movies %>% 
  select(c(name, budgetM, grossM, profitM, profit_percent)) %>% 
  arrange(desc(profit_percent)) %>% 
  top_n(20) %>% 
  knitr::kable(caption = "Top 20 Profit Percentage Movies: Finances", digits = 3) %>% 
  kableExtra::kable_styling(latex_options = c("hold_position"))
```
**Insights:** 
Only 5 movies in the top 20 profit (%) movies had budgets of >= $1M, and none are in the top 10.

The highest profit (%) in the top 20 grossing movies is 1101% by Avatar. 

* This is far lower than the profit (%) in the top 20 profit (%) movies. 

* The lowest profit (%) in the profit (%) list is Fireproof with 6594%

None of the movies in the top 20 profit (%) movies had a gross above $370M.

* Except E.T. which had a gross of $792M

All of the movies in the top 20 gross movies had a profit ($) above $1B.

* except Fate of the Furious which had a profit ($) of $986M

# CORRELATION MATRIX

Make correlation matrix for all variables:
```{r}
labmovies <- movies # separate data frame for labels
label <- LabelEncoder$new()
# non-numerical variables are converted through label encoding:
labmovies$name <- label$fit_transform(labmovies$name) 
labmovies$rating <- label$fit_transform(labmovies$rating)
labmovies$genre <- label$fit_transform(labmovies$genre)
labmovies$director <- label$fit_transform(labmovies$director)
labmovies$writer <- label$fit_transform(labmovies$writer)
labmovies$star <- label$fit_transform(labmovies$star)
labmovies$country <- label$fit_transform(labmovies$country)
labmovies$company <- label$fit_transform(labmovies$company)
labmovies$full_release_location <- label$fit_transform(labmovies$full_release_location)
head(labmovies) # check that numeric labels were applied correctly
corr_matrix <- round(cor(labmovies[, sapply(labmovies, is.numeric)], 
                         use = "complete.obs", method = "pearson"), 2)
```

**Create a refined correlation heat map.**

Get lower triangle of the correlation matrix:
```{r}
get_lower_tri<-function(corr_matrix)
  {
  corr_matrix[upper.tri(corr_matrix)] <- NA
  return(corr_matrix)
  }
```

Get upper triangle of the correlation matrix:
```{r}
get_upper_tri <- function(corr_matrix)
  {
  corr_matrix[lower.tri(corr_matrix)]<- NA
  return(corr_matrix)
  }
```

Return usable data frame:
```{r}
upper_tri <- get_upper_tri(corr_matrix)
upper_tri
```

Helper function to reorder the correlation matrix :
```{r}
reorder_corr_matrix <- function(corr_matrix)
  {
  # Use correlation between variables as distance
  dd <- as.dist((1-corr_matrix)/2)
  hc <- hclust(dd)  # hc = hierarchical clustering
  corr_matrix <-corr_matrix[hc$order, hc$order]
  }
```

Reorder the correlation matrix:
```{r}
corr_matrix <- reorder_corr_matrix(corr_matrix)
upper_tri <- get_upper_tri(corr_matrix)
```

Melt the correlation matrix for plotting:
```{r}
melted_corr_matrix <- melt(upper_tri, na.rm = TRUE)
```

Plot the heat map:
```{r}
ggheatmap <- ggplot(data = melted_corr_matrix, aes(Var2, Var1, fill = value))+
  geom_tile(color = "white")+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal()+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
                                   size = 12, hjust = 1))+
  coord_fixed()
```

Add labels and text to plot:
```{r fig.height = 11, fig.width = 17}
ggheatmap + 
  labs(x = "Movie Features", y = "Movie Features", 
       title = "Correlation Matrix of All Variables", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva") +
  geom_text(aes(Var2, Var1, label = value), color = "black", size = 4) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(0.6, 0.7),
    legend.direction = "horizontal")+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                               title.position = "top", title.hjust = 0.5))
```
\newpage

These correlations are highly logical, such as year-related variables (decades and premieres), and collaboration-related variables (directors and writers often pair up together multiple times, as do stars). 

Country was not highly correlated to other variables, nor was runtime, genre, rating, or profit percentage.

Since I am mostly interested in correlations with gross and profit, I will inspect this more closely.

# CORRELATION LISTS AND SCATTER PLOTS OF SELECTED VARIABLES

Make a list of variables that were highly correlated to gross:
```{r}
gross_high_corr <- melted_corr_matrix %>%
  filter(melted_corr_matrix$Var2 == "grossM" 
         & melted_corr_matrix$value >= 0.5 # this only pulls highly correlated variables
         & melted_corr_matrix$value != 1) %>% # this ignores self-correlated variables
  arrange(desc(value))
tibble(gross_high_corr) # budget and votes have the highest correlation to gross
```
As a reminder, Votes refers to the number of votes that the movies has obtained from IMDB users.

Create a scatter plot with budget vs gross: 
```{r}
# the plot will skip over any NULLs
ggplot(movies, aes(budgetM, grossM)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Budget ($M)", y = "Gross ($M)", 
       title = "Film Budget ($M) vs. Film Gross ($M)", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```
**Insights:** A higher budget helped provide the potential for a higher gross.

Create a scatter plot with votes vs gross:
```{r}
ggplot(movies, aes(votes, grossM)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "IMDB User Votes", y = "Gross ($M)", 
       title = "IMDB User Votes vs. Film Gross ($M)", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```
**Insights:** There were many votes for movies without a high gross. This is possibly because less financially successful movies can gain "cult" followings by certain demographics 

Make a list of variables that were highly correlated to profit ($M):
```{r}
profit_high_corr <- melted_corr_matrix %>%
  filter(melted_corr_matrix$Var2 == "profitM" 
         & melted_corr_matrix$value >= 0.5 
         & melted_corr_matrix$value != 1) %>% 
  arrange(desc(value))
tibble(profit_high_corr) 
```
As expected, profit ($M) was correlated to both gross and budget (and votes).

Make a list of variables that were highly correlated to profit (%):
```{r}
profperc_high_corr <- melted_corr_matrix %>%
  filter(melted_corr_matrix$Var2 == "profit_percent" 
         & melted_corr_matrix$value >= 0.5 
         & melted_corr_matrix$value != 1) %>% 
  arrange(desc(value))
tibble(profperc_high_corr)
```
No high correlations found for profit (%). No scatter plot necessary.

**Correlation Insights: The most profitable (%) movies did not have the highest budgets or gross, but the larger budgets tended to create larger gross.**

# FURTHER ANALYSIS BY CATEGORY (TOTAL RANGE, TOP GROSSING, TOP PROFITABLE($, %), TOP DECADE) 

Here I will continue to investigate variables involved in top grossing and top profitable movies. 

I will also analyze variable involvement throughout the total range of the data set, and variable involvement divided into decade ranges.

## Total Range Analysis of Select Variables

Which stars have been top-billed in the most movies?
```{r}
stars <- movies %>% 
  count(star, sort = TRUE) %>% 
  top_n(25)
```

Plot via column chart:
```{r fig.height = 5, fig.width = 7}
ggplot(stars) +
  geom_col(aes(x = reorder(star, n), y = n)) +
  labs(x = "Star", y = "Number of Movies", 
       title = "Which stars have been top-billed in the most movies?", 
       subtitle = "Top 25 Stars: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95))
```
Cage, De Niro, and Hanks are a clear Top 3.

Note: I have to go all the way down to #24 before finding a female top-billed actor (Streep).

Which film production company made the most movies?
```{r}
companies <- movies %>% 
  count(company, sort = TRUE) %>% 
  top_n(10)
```

Plot via column chart:
```{r}
ggplot(companies) +
  geom_col(aes(x = reorder(company, n), y = n)) +
  labs(x = "Company", y = "Number of Movies", 
       title = "Which film production company makes the most movies?", 
       subtitle = "Top 10 Companies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95))
```
Universal, Warner Bros., Columbia, and Paramount are a clear Top 4 with over 300 films in the last 4 decades.

Universal appears multiple times on the Top 20 grossing list, and Warner Bros. appears once. 

* Columbia and Paramount are not on the Top 20 grossing list.

* 20th Century and Walt Disney Pictures appear multiple times on the Top 20 grossing list, but made far less movies in the last 4 decades than the top 4 movie-making companies.

Which writers worked on the most movies?
```{r}
writers <- movies %>% 
  count(writer, sort = TRUE) %>% 
  top_n(10)
```

Plot via column chart:
```{r}
ggplot(writers) +
  geom_col(aes(x = reorder(writer, n), y = n)) +
  labs(x = "Writer", y = "Number of Movies", 
       title = "Which writers worked on the most movies?", 
       subtitle = "Top 10 Writers: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95))
```
At the top, Woody Allen and Stephen King have written over 30 movies, and Luc Besson and John Hughes have written over 20 movies.

* None of the top 10 writers wrote the Top 20 grossing movies, nor the most profitable movies ($ or %).

Which directors worked on the most movies?
```{r}
directors <- movies %>% 
  count(director, sort = TRUE) %>% 
  top_n(10)
```
Plot via column chart:
```{r}
ggplot(directors) +
  geom_col(aes(x = reorder(director, n), y = n)) +
  labs(x = "Director", y = "Number of Movies", 
       title = "Which directors worked on the most movies?", 
       subtitle = "Top 10 Directors: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95))
```
At the top,Woody Allen and Clint Eastwood directed over 30 movies.

* None of the Top 10 directors wrote the Top 20 grossing movies, nor the most profitable movies ($ or %).

Which film rating was used the most?
```{r}
ratings <- movies %>% 
  count(rating, sort = TRUE) %>% 
  top_n(3)
```

Plot via column chart:
```{r}
ggplot(ratings) +
  geom_col(aes(x = reorder(rating, n), y = n)) +
  labs(x = "Rating", y = "Number of Movies", 
       title = "Which film rating was used the most?", 
       subtitle = "Top 3 Ratings: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```
R rated films were made the most often (3698), followed by PG-13 (2112) and PG (1252).

What was the average film runtime for each film rating?
```{r}
runtime <- movies %>%
  filter(!is.na(runtime), rating != "") %>% 
  group_by(rating) %>% 
  summarise(AVGruntime = mean(runtime)) %>% 
  arrange(desc(AVGruntime))
```

Plot via column chart:
```{r}
ggplot(runtime) +
  geom_col(aes(x = reorder(rating, AVGruntime), y = AVGruntime)) +
  labs(x = "Rating", y = "Average Runtime (min)", 
       title = "What was the average film runtime for each rating?", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva") +
  coord_cartesian(ylim = c(60, 120))
```
PG, TV-14, and G movies had the shortest runtime. 

* PG and G make sense, since these are geared towards young children with shorter attention spans.

What was the average runtime for each film genre?
```{r}
genre <- movies %>%
  filter(!is.na(runtime)) %>% 
  group_by(genre) %>% 
  summarise(AVGruntime = mean(runtime)) %>% 
  arrange(desc(AVGruntime))
```

Plot via column chart:
```{r}
ggplot(genre) +
  geom_col(aes(x = reorder(genre, AVGruntime), y = AVGruntime)) +
  labs(x = "Genre", y = "Average Runtime (min)", 
       title = "What was the average runtime for each film genre?", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva") +
  coord_cartesian(ylim = c(60, 140)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95))
```
Musicals were by far the longest (136 min). Animation was significantly lower at 92 min.

What companies made the most movies within each genre?
```{r}
compGenre <- movies %>% 
  group_by(genre, company) %>% 
  count(genre, sort = TRUE) 
compGenre <- compGenre %>%
  arrange(desc(n)) %>%  
  group_by(genre) %>%
  slice(1:2)  # Top 2 highest values (number of movies made by company) by group (genre)
compGenre <- compGenre %>%  #some genres had < 10 movies, so I will cut them from the list
  filter(genre != "Family", genre != "Musical", genre != "Mystery", genre != "Romance",
         genre != "Sci-Fi", genre != "Thriller", genre != "Western")
print(compGenre)
```

Plot via clustered column chart:
```{r}
ggplot(compGenre) +
  geom_col(aes(x = reorder(genre, n), y = n, fill = company), position = "dodge") +
  labs(x = "Genre", y = "Number of Movies", 
       title = "What companies made the most movies from within each genre?", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95))
```
Warner Bros. made the most Action movies (127).

Universal Pictures made the most Comedy movies (132).

## Top Grossing Analysis of Select Variables

Top 20 Highest Grossing Movies:
```{r}
top20gross <- movies %>% 
  select(c(name, rating, runtime, genre, profitM, profit_percent, grossM)) %>% 
  arrange(desc(grossM)) %>% 
  top_n(20)
top20gross %>% 
  knitr::kable(caption = "Top 20 Grossing Movies: Categorical", digits = 0) %>% 
  kableExtra::kable_styling(latex_options = c("hold_position")) %>% 
  column_spec(c(1), width = "3cm")
```

Which rating was the most popular among top grossing movies?
```{r}
ratingtop20gross <- top20gross %>% 
  count(rating, sort = TRUE)
```

Plot via column chart:
```{r}
ggplot(ratingtop20gross, aes(rating, n)) +
  geom_col() +
  labs(x = "Rating", y = "Number of Movies",
       title = "Which rating was the most popular among the top 20 grossing movies?", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```
PG-13 movies dominated the Top 20 Highest Grossing Movie list with 15.

PG movies have 5, and R movies have 0.

What was the average runtime of the highest grossing movies (Top 20)?
```{r}
runtimetop20gross <- top20gross %>% 
  group_by(rating) %>% 
  summarise(AVGruntime = mean(runtime)) %>% 
  arrange(desc(AVGruntime))
```

Plot via column chart:
```{r}
ggplot(runtimetop20gross, aes(rating, AVGruntime)) +
  geom_col() +
  labs(x = "Rating", y = "Average Runtime (min)",
       title = "What was the average runtime of the highest grossing movies (Top 20)?", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```
For PG-13, the avg runtime of the top 20 grossing movies was 145 min, which was 36 min longer than the avg of all PG-13 movies.

For PG, the ave runtime of the top 20 grossing movies was 114 min, which was 9 min longer than the avg of all PG movies.

What genres appeared the most in the Top 20 Grossing movies list?
```{r}
genretop20gross <- top20gross %>% 
  group_by(genre) %>% 
  count(genre, sort = TRUE)
```

Plot via column chart:
```{r}
ggplot(genretop20gross, aes(x = reorder(genre, n), y = n)) +
  geom_col() +
  labs(x = "Genre", y = "Number of Movies",
       title = "What genres appeared the most in the Top 20 Grossing movies list?", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```
Action movies accounted for 13 out of the top 20 grossing films.

## Top Profitable Analysis of Select Variables

Top 20 Movies with Highest Profit Percentage:
```{r}
top20profperc <- movies %>% 
  select(c(name, rating, runtime, genre, profitM, profit_percent)) %>% 
  arrange(desc(profit_percent)) %>% 
  top_n(20)
top20profperc %>% 
  knitr::kable(caption = "Top 20 Profitable Movies: Categorical", digits = 3) %>% 
  kableExtra::kable_styling(latex_options = c("hold_position"))
```

Which rating was most popular among top movies by profit percentage?
```{r}
ratingtop20profperc <- top20profperc %>% 
  count(rating, sort = TRUE)
```

Plot via column chart:
```{r}
ggplot(ratingtop20profperc, aes(x = reorder(rating, n), y = n)) +
  geom_col() +
  labs(x = "Rating", y = "Number of Movies",
       title = "Which rating was most popular among top movies by profit percentage?", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```
R movies dominated the top profit (%) movie list with 13.

PG movies had 4, and PG-13 movies had 3.

What was the average runtime per rating of the Top 20 most profitable (%) movies?
```{r}
runtimetop20profperc <- top20profperc %>% 
  group_by(rating) %>% 
  summarise(AVGruntime = mean(runtime)) %>% 
  arrange(desc(AVGruntime))
```

Plot via column chart:
```{r}
ggplot(runtimetop20profperc, aes(x = reorder(rating, AVGruntime), y = AVGruntime)) +
  geom_col() +
  labs(x = "Rating", y = "Average Runtime (min)",
       title = 
         "What was the average runtime per rating of the Top 20 most profitable (%) movies?", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```
For PG, the avg runtime of the top 20 most profitable (%) movies was 107 min, which was 4 min longer than the avg of all PG movies.

For PG-13, the avg runtime of the top 20 most profitable (%) movies was 92 min, which was 17 min less than the avg of all PG-13 movies.

For R, the avg runtime of the top 20 most profitable (%) movies was 89 min, which was 19 min less than the avg of all R movies.

**Insights:** top grossing movies were significantly longer compared to all movies with the same ratings. 

* Top profitable (%) movies were generally shorter than the average, perhaps due to smaller budgets.

What genres appeared the most in the Top 20 Most Profitable (%) movies list?
```{r}
genretop20profperc<- top20profperc %>% 
  group_by(genre) %>% 
  count(genre, sort = TRUE)
```

Plot via column chart:
```{r}
ggplot(genretop20profperc, aes(x = reorder(genre, n), y = n)) +
  geom_col() +
  labs(x = "Rating", y = "Average Runtime (min)",
       title = 
         "What genres appeared the most in the Top 20 Most Profitable (%) movies list?", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```
Horror had the most (7), followed by Comedy (6) and Drama (4). 

* Only 1 Action film, which contrasts with the top grossing genres.  

What was the total profit ($M) of each company? 
```{r}
top10profitcomp <- movies %>% 
  group_by(company) %>% 
  summarise(profitM = sum(profitM)) %>% 
  arrange(desc(profitM)) %>% 
  top_n(10)
```

Plot via column chart:
```{r}
ggplot(top10profitcomp, aes(x = reorder(company, profitM), y = profitM)) +
  geom_col() +
  labs(x = "Company", y = "Profit ($M)",
       title = "What was the total profit ($M) of each company?", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95))
```
Marvel had the most profit by far ($12B), followed by Dreamworks ($8B), Pixar ($6B), and Lucasfilm ($6B).

**Avg profit per movie of each company (with at least 5 movies)**

Use companies that have made at least 5 movies:
```{r}
compN <- movies %>% 
  group_by(company) %>% filter(n() >= 5) %>% ungroup()
```

What was the average profit ($M) per movie of each company?
```{r}
profcompN <- compN %>% 
  group_by(company) %>% 
  summarise(profitM = mean(profitM)) %>% 
  arrange(desc(profitM)) %>% 
  top_n(10)
```

Plot via column chart:
```{r}
ggplot(profcompN, aes(x = reorder(company, profitM), y = profitM)) +
  geom_col() +
  labs(x = "Company", y = "Profit ($M)",
       title = "What was the average profit ($M) per movie of each company?", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95))
```
Marvel Studios made about $1B profit per movie.

What was the average profit (%) per movie of each company?
```{r}
perccompN <- compN %>% 
  group_by(company) %>% 
  summarise(profit_percent = mean(profit_percent)) %>% 
  arrange(desc(profit_percent)) %>% 
  top_n(10)
```

Plot via column chart:
```{r}
ggplot(perccompN, aes(x = reorder(company, profit_percent), y = profit_percent)) +
  geom_col() +
  labs(x = "Company", y = "Profit (%)",
       title = "What was the average profit (%) per movie of each company?", 
       subtitle = "Movies: 1980-2020", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95))
```
FilmDistrict, Exclusive Media Group, and Twisted Pictures all averaged over 1000% profit from their movies.

## Decade Analysis of Select Variables

Note: For Decade Analysis, I did not include 2020 films.

How many movies did companies make each decade (80s, 90s, 00s, 10s)?
```{r}
compDecade <- movies %>% 
  filter(!is.na(decade), decade != 2020) %>% # eliminate NA decades and 2020 films 
  group_by(decade, company) %>% 
  count(decade, sort = TRUE) 
compDecade <- compDecade %>%
  arrange(desc(n)) %>%  
  group_by(decade) %>%
  slice(1:5)  # Top 5 highest values (number of movies made by company) by group (decade)
compDecade
```

Plot via clustered column chart:
```{r}
ggplot(compDecade) +
  geom_col(aes(x = decade, y = n, fill = company), position = "dodge") +
  labs(x = "Decade", y = "Number of Movies", 
       title = "How many movies did companies make each decade?", 
       subtitle = "Decades: 1980s, 1990s, 2000s, 2010s", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```

Did movies gross more in a certain decade?
```{r}
profdecade <- movies %>%
  filter(!is.na(profitM), decade != 2020) %>% 
  group_by(decade) %>%
  summarise(profitB = sum(profitM) / 1000) %>% 
  arrange(desc(profitB))
```

Plot via column chart:
```{r}
ggplot(profdecade, aes(x = decade, y = profitB)) +
  geom_col() +
  labs(x = "Decade", y = "Profit ($B)",
       title = "Did movies gross more in a certain decade?", 
       subtitle = "Decades: 1980s, 1990s, 2000s, 2010s", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```
There was a cumulative rise in gross each decade. The cumulative rise in movie ticket prices is one possible factor.

Were movies more profitable (%) in a certain decade?
```{r}
percdecade <- movies %>%
  filter(!is.na(profit_percent), decade != 2020) %>% 
  group_by(decade) %>%
  summarise(profit_percent = mean(profit_percent)) %>% 
  arrange(desc(profit_percent))
```

Plot via column chart:
```{r}
ggplot(percdecade, aes(x = decade, y = profit_percent)) +
  geom_col() +
  labs(x = "Decade", y = "Profit (%)",
       title = "Were movies more profitable (%) in a certain decade?", 
       subtitle = "Decades: 1980s, 1990s, 2000s, 2010s", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```
Movies were significantly more profitable (%) in the 2010s (1157%), followed by 2000s (437%), 1980s (329%), and 1990s (222%). 

How did average runtimes differ in certain decades?
```{r}
runtimedecade <- movies %>%
  filter(!is.na(runtime), decade != 2020) %>% 
  group_by(decade) %>% 
  summarise(AVGruntime = mean(runtime)) %>% 
  arrange(desc(AVGruntime))
```

Plot via column chart:
```{r}
ggplot(runtimedecade, aes(x = decade, y = AVGruntime)) +
  geom_col() +
  labs(x = "Decade", y = "Average Runtime (min)",
       title = "How did average runtimes differ in certain decades?", 
       subtitle = "Decades: 1980s, 1990s, 2000s, 2010s", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva") +
  coord_cartesian(ylim = c(95, 110))
```
On average, movies get longer every decade. 

Were some genres made more than others in certain decades?
```{r}
genredecade <- movies %>%
  filter(!is.na(genre), decade != 2020) %>%  
  filter(genre == "Comedy" | genre == "Action" | genre == "Drama" | genre == "Horror") %>% 
  group_by(decade) %>% 
  count(genre, sort = TRUE) %>% 
  arrange(genre)
```

Plot via clustered column chart:
```{r}
ggplot(genredecade) +
  geom_col(aes(x = decade, y = n, fill = genre), position = "dodge") +
  labs(x = "Decade", y = "Number of Movies", 
       title = "Were some genres made more than others in certain decades?", 
       subtitle = "Decades: 1980s, 1990s, 2000s, 2010s", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```
More action movies were made in 00s-10s than in 80s-90s.

More comedy movies were made in 90s-00s than in 80s/10s.

More drama movies were made in 90s-00s than in 80s/10s.

More horror movies were made in 00s-10s than in 80s-90s.

Were some ratings used more than others in certain decades?
```{r}
ratingdecade <- movies %>%
  filter(!is.na(rating), decade != 2020) %>%  
  filter(rating == "PG" | rating == "PG-13" | rating == "R") %>% 
  group_by(decade) %>% 
  count(rating, sort = TRUE) %>% 
  arrange(rating)
```

Plot via clustered column chart:
```{r}
ggplot(ratingdecade) +
  geom_col(aes(x = decade, y = n, fill = rating), position = "dodge") +
  labs(x = "Decade", y = "Number of Movies", 
       title = "Were some ratings used more than others in certain decades?", 
       subtitle = "Decades: 1980s, 1990s, 2000s, 2010s", 
       caption = "Source: 
       'Movie Industry, Four Decades of Movies' IMDB dataset, 
       posted on Kaggle by Daniel Grijalva")
```
More PG rated movies were made in 80s-90s than in 00s-10s.

More PG-13 rated movies were made in 00s-10s than in 80s-90s (inverse relationship between PG and PG-13 in these decades).

More R rated movies were made in 90s-00s than in 80s/10s.

# RECAP OF INSIGHTS

* Except for Avatar and Titanic, all the Top 20 grossing movies premiered in the last decade, and were mostly franchise-related.

* The Top 20 profitable (%) movies are more spread out over the decades, none are sequels, and no stars, directors, writers, or companies appear more than once.

* The most profitable (%) movies generally succeeded despite their low budget.

* None of the movies in the top 20 profit (%) movies had a gross above $370M. 

* All of the movies in the top 20 grossing movies had a profit ($) above $1B.

* The most profitable (%) movies did not have the highest budgets or gross, but the larger budgets tended to create larger gross.

* There have been more R rated movies made than movies with any other rating. None of the top 20 grossing movies were rated R, but the majority of top 20 profitable (%) movies were rated R.

* The top 20 grossing movies were significantly longer compared to all movies with the same ratings; the top 20 profitable (%) movies were generally shorter.

* Action movies accounted for 13 out of the top 20 grossing films; Horror and Comedy combined for 13 out of the top 20 profitable (%) films. 

* Marvel had the most profit of all film companies ($12B), followed by Dreamworks ($8B), Pixar ($6B), and Lucasfilm ($6B). Marvel made about $1B profit per movie.

* FilmDistrict, Exclusive Media Group, and Twisted Pictures all averaged over 1000% profit from their movies.

* There was a cumulative rise in gross among all movies each decade. 

* Movies were significantly more profitable (%) in the 2010s (1157%), followed by 2000s (437%), 1980s (329%), and 1990s (222%).

* On average, movies get longer every decade.

# PREPARE AND EXPORT CSV FOR TABLEAU

Revert the gross, budget, and profit to their original values for Tableau:
```{r}
tabmovies <- movies
tabmovies$gross <- movies$grossM * 1000000
tabmovies$budget <- movies$budgetM * 1000000
tabmovies$profit <- movies$profitM * 1000000
tabmovies <- tabmovies %>%
  select(-c(grossM, budgetM, profitM))
```

Are there any duplicate movie titles?
```{r}
length(unique(tabmovies$name)) == nrow(tabmovies)
```
There are some duplicate movie titles in this data set, which causes issues in Tableau. For example, Tableau will combine the gross of "The Lion King" (1994) and the "The Lion King (2019), thinking that these are the same movie. This skews the output of my dashboard.

Paste Name and Premiere together to make each movie name unique:
```{r}
tabmovies$name <- paste(tabmovies$name, tabmovies$premiere, sep = " (")

```

Append a closing parenthesis:
```{r}
tabmovies$name <- paste(tabmovies$name, ")", sep = "")
```

Export as CSV <- write.csv(movies, "filepath/filename.csv", row.names = FALSE):
```{r, include=FALSE}
write.csv(tabmovies,"C:/Users/garci/OneDrive/Desktop/Data Analysis Education/Alex the Analyst Projects/Movies/tabmovies.csv", row.names = FALSE)
```
